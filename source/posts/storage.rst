===================================
虚拟化中存储配置典型场景－启动风暴
===================================

桌面私有云相较于一般公有云，有着虚拟机启动密度大、服务器资源冗余性低等特点，本文尝试模拟桌面云中的教学机房场景来说明启动风暴问题的解决方法，并在现有方法的基础上提出一些改进措施，对公有云也有一定参考价值。

1. 现有虚拟化平台的一般配置介绍
===============================

1. 现有虚拟化平台的镜像存储介绍

现有比较成熟的开源虚拟化/云计算平台，包括OpenStack、CloudStack和oVirt等，都有比较清晰的模板和实例概念，同时也有模板与实例镜像存储位置相关的存储域配置，为了区分虚拟机中的模板与实例，我们下文都默认：模板即原始虚拟机，所有新实例的创建都依赖于它；实例即依赖模板创建的虚拟机，是具有运行生命周期的虚拟机通称。

在虚拟化平台中，一般有两种新建实例的方式：克隆与增量。

克隆即完整克隆模板配置与磁盘，磁盘的创建方式一般为cp或者qemu-img convert。如此创建的实例，其磁盘与模板磁盘相对独立，在服务器存储上拥有各自的扇区位置，所以在读写操作时受机械盘磁头引起的小区域并发问题影响较小，缺点是创建时需要消耗一定时间，不能满足秒级创建的需求。

增量即新建虚拟机只复制模板配置信息，但其磁盘文件通过qemu-img的backing file方法创建，基于backing file创建的磁盘不能是raw格式，命令如下：

.. code::

       qemu-img create -b hda.qcow2 -f qcow2 hda-new.qcow2

如此创建的磁盘对模板磁盘的依赖较大，非增量文件的读操作（比如启动系统）绝大部分在模板磁盘上进行，所以在传统机械盘上多个实例的并发启动风暴更容易在此种格式的磁盘上发生。

-----------------------
1.1. 模板与实例同一存储
-----------------------

当模板与实例存储在同一文件系统中时，我们创建虚拟机的常用方法有两种————使用模板的磁盘的hardlink作为实例磁盘的backing file来创建增量磁盘，或者直接克隆模板磁盘。

在同一文件系统上使用hardlink的而非softlink的好处有：

1. 节省inode；由于省去了访问softlink的inode这一步，直接访问原文件的inode会带来性能上的稍许提升；改变源文件路径不会影响hardlink文件的访问；安全性考虑，只有删除了源文件以及指向源文件inode的hardlink，文件内容才会丢失。

于oVirt中我们可以看到如下的目录结构：

-----------------------
1.2. 模板与实例分离存储
-----------------------

模板磁盘与实例磁盘分别存储在不同的文件系统中时，已经不能使用hardlink创建

-----------------------------------
1.3. 无状态实例的磁盘与快照分离存储
-----------------------------------

2. 启动风暴相关系列试验
=======================

---------------------------
2.1. WD 15K SAS启动win7实验
---------------------------

-------------------------------
2.2. Intel 120G SSD启动win7实验
-------------------------------

3. 私有云中处理启动风暴的常用方法
=================================

-------------
3.1. 启动排队
-------------

--------------
3.2. SSD一站式
--------------

-----------------------------------------
3.3. 引入二级实例存储池改善常驻桌面IO分布
-----------------------------------------

-----------------------------------------
3.4. 引入二级快照存储池改善临时桌面IO分布
-----------------------------------------

---------------
3.5. bcache测试
---------------

4. 总结 
=======
